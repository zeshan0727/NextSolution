name: Generate Movie Pages - Simple

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create generation script
        run: |
          cat > generate-movies.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // Read movies.html
          const moviesHtml = fs.readFileSync('movies.html', 'utf8');
          
          // Extract movies array
          const moviesMatch = moviesHtml.match(/const movies = (\[.*?\]);/s);
          if (!moviesMatch) {
            console.error('Could not find movies array');
            process.exit(1);
          }
          
          // Parse movies (simplified - assumes clean format)
          let moviesStr = moviesMatch[1];
          
          // Clean up the string for parsing
          moviesStr = moviesStr
            .replace(/\n/g, '')
            .replace(/\s+/g, ' ')
            .replace(/title:/g, '"title":')
            .replace(/link:/g, '"link":')
            .replace(/'/g, '"');
          
          let movies;
          try {
            movies = JSON.parse(moviesStr);
          } catch (e) {
            console.error('Error parsing movies:', e.message);
            
            // Fallback: manual parsing
            const movieRegex = /\{\s*title:\s*"([^"]+)",\s*link:\s*"([^"]+)"\s*\}/g;
            movies = [];
            let match;
            while ((match = movieRegex.exec(moviesMatch[1])) !== null) {
              movies.push({
                title: match[1],
                link: match[2]
              });
            }
          }
          
          console.log(`Found ${movies.length} movies`);
          
          // Read template
          const template = fs.readFileSync('movie-template.html', 'utf8');
          
          // Create movies directory
          const moviesDir = 'movies';
          if (!fs.existsSync(moviesDir)) {
            fs.mkdirSync(moviesDir, { recursive: true });
          }
          
          // Generate pages
          let count = 0;
          for (const movie of movies) {
            try {
              // Extract year from title
              const yearMatch = movie.title.match(/\((\d{4})\)/);
              const year = yearMatch ? yearMatch[1] : '2024';
              const cleanTitle = movie.title.replace(/\(\d{4}\)/g, '').trim();
              
              // Create slug
              let slug = cleanTitle
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .substring(0, 50);
              
              if (slug.endsWith('-')) slug = slug.slice(0, -1);
              
              // Replace placeholders
              let page = template
                .replace(/{{MOVIE_TITLE}}/g, cleanTitle)
                .replace(/{{MOVIE_YEAR}}/g, year)
                .replace(/{{MOVIE_URL}}/g, movie.link);
              
              // Write file
              fs.writeFileSync(path.join(moviesDir, `${slug}.html`), page);
              count++;
              
              if (count % 10 === 0) {
                console.log(`Generated ${count} pages...`);
              }
            } catch (error) {
              console.error(`Error with ${movie.title}:`, error.message);
            }
          }
          
          console.log(`\nGenerated ${count} movie pages in /movies directory`);
          EOF
          
      - name: Run generation script
        run: node generate-movies.js
        
      - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add movies/
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Add generated movie pages"
            git push
          fi
